{{set . "title" "bills"}}
{{template "header.html" .}}

{{set . "active" "bills"}}
{{template "navigation.html" .}}

<style>
    table td {
        font-size: 12px;
    }

    .alert {
        padding: 0 14px;
        margin-bottom: 0;
        display: inline-block;
    }
</style>

<div class="container">
    <div class="row">
        <div class="span6">{{template "flash.html" .}}</div>
    </div>
    <span class="alert"></span>
</div>

<div class="container">
  <p>
    <div class="col-sm-offset-2 col-sm-4">
      <a role="button" class="btn btn-primary" href="{{url "Bills.New"}}">{{msg . "add"}}</a>
    </div>
  </p>
</div>

<div class="container">
  {{if not .bills}}
  <p>No Found</p>
  {{else}}
  <!-- class="table table-striped table-bordered table-condensed table-responsive" -->
  <table id="table"
        data-toggle="table"
        data-show-toggle="true"
        data-show-columns="true"
        data-sort-name="date"
        data-sort-order="desc"
        data-pagination="true"
        data-page-size="20"
        data-page-list="[20, 30, 40, 50]"
        data-show-pagination-switch="true"
        data-detail-view="true"
        data-detail-formatter="detailFormatter"
        data-filter-control="true"
        data-id-field="id">
    <thead>
      <tr >
        <th data-field="date" data-halign="center" data-align="left" data-sortable="true" data-filter-control="select">{{msg . "date"}}</th>
        <th data-field="title" data-halign="center" data-align="left" data-filter-control="input">{{msg . "title"}}</th>
        <th data-field="amount" data-halign="center" data-align="left" data-sortable="true">{{msg . "amount"}}</th>
        <th data-field="account" data-halign="center" data-align="left" data-sortable="true" data-visible="false" data-filter-control="select">{{msg . "account"}}</th>
        <th data-field="catelog" data-halign="center" data-align="left" data-sortable="true" data-visible="false" data-filter-control="select">{{msg . "catelog"}}</th>
        <th data-field="description" data-halign="center" data-align="left" data-visible="false">{{msg . "description"}}</th>
        <th data-field="uid" data-events="operateEvents" data-formatter="operateFormatter" data-visible="false">{{msg . "operate"}}</th>
      </tr>
    </thead>
    <tbody>
      {{range .bills}}
      <tr>
        <td>{{.Date.Format "2006-01-02"}}</td>
        <td>{{.Title}}</td>
        <td>{{.Amount}}</td>
        <td>{{.Account_name}}</td>
        <td>{{.Catelog_name}}</td>
        <td>{{.Description}}</td>
        <td style="display:none;">{{.Bill_id}}</td>
      </tr>
      {{end}}
    </tbody>
  </table>
  {{end}}
</div>

<script>
    var del_url = {{url "Bills.Delete"}};
    var index_url = {{url "Bills.Index"}};

    var $table = $('#table'),
            $alert = $('.alert').hide();


  function detailFormatter(index, row) {
    var html = [];

    $.each(row, function (key, value) {
      var mKey;
      switch (key){
        case "date":
              mKey = {{msg . "date"}};
      break;
      case "title":
              mKey = {{msg . "title"}};
      break;
      case "amount":
              mKey = {{msg . "amount"}};
      break;
      case "account":
              mKey = {{msg . "account"}};
      break;
      case "catelog":
              mKey = {{msg . "catelog"}};
      break;
      case "description":
              mKey = {{msg . "description"}};
      break;
        default:
      return;
      }
        html.push('<p><b>' + mKey + ':</b> ' + value + '</p>');
    });
    return html.join('');
  }

  function amountSorter(a, b) {

    var ia = parseFloat(a);
    var ib = parseFloat(b);
    if (ia > ib) return 1;
    if (ia < ib) return -1;
    return 0;
  }

  window.operateEvents = {

    'click .remove': function (e, value, row, index) {
      //alert('You remove like action, row: ' + JSON.stringify(row));
      if (confirm({{msg . "delete"}} + row.title +'?')) {
        $.ajax({
          url: del_url,
          type: 'post',
		  data:{uid:row.uid},
          success: function (data) {
              $table.bootstrapTable('remove', {
                  field: 'uid',
                  values: [row.uid]
              });
              showAlert(row.title + {{msg . "delete.successed"}}, 'success');
          },
          error: function () {
              showAlert(row.title + {{msg . "delete.failed"}}, 'danger');
          }
        });
      }
    }
  };

    function operateFormatter(value, row, index) {
        return [
            '<a class="remove" href="javascript:void(0)" title="Remove">',
            '<i class="glyphicon glyphicon-remove"></i>',
            '</a>'
        ].join('');
    }

    function showAlert(title, type) {
        $alert.attr('class', 'alert alert-' + type || 'success')
                .html('<i class="glyphicon glyphicon-check"></i> ' + title).show();
        setTimeout(function () {
            $alert.hide();
        }, 3000);
    }

</script>
{{template "footer.html" .}}